<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Confirma√ß√£o de Presentes ‚Äî Casamento</title>

  <!-- Bootstrap 5 (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-..." crossorigin="anonymous">
  <!-- SweetAlert2 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Axios (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Feather icons (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <!-- Inputmask (CDN) for telefone -->
  <script src="https://cdn.jsdelivr.net/npm/inputmask@5/dist/inputmask.min.js"></script>

  <style>
    /* ======================================================
   üé© TEMA LUXO ‚Äì PRETO | CINZA | BRANCO
   Estilo premium para site de casamento
====================================================== */

:root {
  --black: #000;
  --dark: #111;
  --gray-1: #1a11;
  --gray-2: #2a2a2a;
  --gray-3: #ccc;
  --gray-4: #eee;
  --white: #fff;

  --border-soft: rgba(255,255,255,0.08);
  --shadow-soft: 0 8px 28px rgba(0,0,0,0.35);
  --shadow-soft-light: 0 6px 20px rgba(0,0,0,0.18);

  --radius: 1rem;

  --font-title: "Playfair Display", serif;
  --font-text: "Helvetica Neue", Arial, sans-serif;
}

/* BACKGROUND GERAL */
body {
  background: radial-gradient(circle at top, #1a1a1a, #000);
  color: var(--white);
  font-family: var(--font-text);
  margin: 0;
}

/* HEADER */
.hero {
  background: linear-gradient(135deg, #000, #1a1a1a);
  padding: 30px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 5px 25px rgba(0,0,0,0.4);
}

.hero h1 {
  font-family: var(--font-title);
  font-size: 1.8rem;
  letter-spacing: 0.5px;
}

.hero small {
  font-weight: 300;
  opacity: .85;
}

.hero button {
  border-radius: 8px !important;
}

/* TITULOS */
h2, h3, h5 {
  font-family: var(--font-title);
}

.small-muted {
  font-size: .9rem;
  color: #bdbdbd !important;
}

/* GRID PRESENTES */
.grid-presente {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 22px;
}

/* CARD DE PRESENTE */
.card-presente {
  background: var(--white);
  color: var(--dark);
  border-radius: var(--radius);
  box-shadow: var(--shadow-soft-light);
  border: none;
  overflow: hidden;
  transition: .3s ease;
}

.card-presente:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 35px rgba(0,0,0,0.28);
}

.foto-presente {
  height: 200px;
  width: 100%;
  object-fit: cover;
}

/* BOT√ÉO RESERVAR */
.card-presente .btn-success {
  background: var(--black) !important;
  border: none;
  letter-spacing: .5px;
  padding: 6px 12px;
}

.card-presente .btn-success:hover {
  background: #333 !important;
}

/* INPUTS */
input.form-control {
  border-radius: 0.7rem;
}

/* BOT√ïES GERAIS */
.btn-primary {
  background: var(--black) !important;
  border: none !important;
}

.btn-primary:hover {
  background: #333 !important;
}

.btn-outline-light:hover {
  background: #fff !important;
  color: #111 !important;
}

/* BOT√ÉO CANCELAR */
.btn-danger {
  background: #b70000 !important;
  border: none !important;
}

.btn-danger:hover {
  background: #8a0000 !important;
}

/* MODAL */
.modal-content {
  background: var(--white);
  color: var(--dark);
  border-radius: var(--radius);
  border: none;
  overflow: hidden;
  box-shadow: var(--shadow-soft);
}

.modal-header {
  background: var(--black);
  color: var(--white);
  border-bottom: none;
}

#btnConfirmarPresente {
  background: var(--black) !important;
  color: var(--white) !important;
  border: none;
  padding: 12px;
  border-radius: .8rem;
  font-size: 1rem;
}

#btnConfirmarPresente:hover {
  background: #222 !important;
}

/* FOOTER */
footer {
  padding: 40px 0;
  border-top: 1px solid rgba(255,255,255,0.05);
  opacity: .75;
  font-family: var(--font-text);
}

/* SUAVIZA LINKS */
a {
  color: #333;
  text-decoration: none;
  font-weight: 500;
}

a:hover {
  opacity: 0.7;
}

/* ===========================
   SweetAlert2 ‚Äì Tema Luxo
=========================== */

.swal2-popup {
  background: #111 !important;
  color: #fff !important;
  border-radius: 1rem !important;
  padding: 20px !important;
  box-shadow: 0 8px 40px rgba(0,0,0,0.6) !important;
}

.swal2-title {
  font-family: "Playfair Display", serif !important;
  color: #fff !important;
  font-size: 1.6rem !important;
}

.swal2-html-container {
  color: #ddd !important;
  font-size: 1rem !important;
}

.swal2-confirm {
  background: #000 !important;
  border-radius: 0.7rem !important;
  border: none !important;
  padding: 10px 22px !important;
}

.swal2-confirm:hover {
  background: #222 !important;
}

.swal2-cancel {
  background: #333 !important;
  color: #fff !important;
  border-radius: 0.7rem !important;
  border: none !important;
}

.swal2-cancel:hover {
  background: #444 !important;
}

  </style>
</head>
<body>

  <header class="hero py-4">
    <div class="container d-flex align-items-center justify-content-between">
      <div>
        <h1 class="h3 mb-0">Confirme seu presente ‚Äî <small>EUZIMAR & DANIELA</small></h1>
        <div class="small">Escolha com carinho ‚Äî tudo em tempo real.</div>
      </div>
      <div>
        <button id="btnConsultar" class="btn btn-light btn-sm me-2">Minhas Escolhas</button>
        <button id="btnRefresh" class="btn btn-outline-light btn-sm">Atualizar</button>
      </div>
    </div>
  </header>

  <main class="container my-4">

    <section class="mb-3">
      <div class="d-flex align-items-center justify-content-between">
        <h2 class="h5">Cat√°logo de Presentes</h2>
        <div class="small-muted">Toque em um presente para ver detalhes e confirmar.</div>
      </div>
    </section>

    <section id="catalogo" class="grid-presente" aria-live="polite">
      <!-- cards gerados pela JS -->
    </section>

<section id="minhasEscolhas" class="mt-5" style="display:none">
  <h2 class="h5 mb-3">Minhas escolhas</h2>
  <div id="listaEscolhas" class="grid-presente"></div>
</section>

    <hr class="my-4">

    <section class="row">
      <div class="col-md-6">
        <h3 class="h6">Confirmar por telefone</h3>
        <form id="formConsulta" class="row g-2">
          <div class="col-8">
            <input id="telefoneConsulta" class="form-control" placeholder="(DDD) 9xxxx-xxxx" />
          </div>
          <div class="col-4">
            <button class="btn btn-primary w-100" type="submit">Consultar</button>
          </div>
        </form>
      </div>
    </section>

    <footer class="text-center mt-5 small-muted">
      <div>Feito com ‚ù§Ô∏è ‚Äî de Euzimar & Daniela.</div>
      <div class="mt-2">Vers√£o: 1.0</div>
    </footer>

  </main>

  <!-- Modal template (Bootstrap 5) -->
  <div class="modal fade" id="modalDetalhe" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background:var(--accent-1); color:white">
          <h5 class="modal-title">Detalhe do Presente</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <img id="mdFoto" src="" alt="foto" class="img-fluid mb-3 rounded">
          <h5 id="mdNome"></h5>
          <p id="mdLink"></p>

          <hr>

          <div class="mb-2">
            <label class="form-label">Seu nome</label>
            <input id="mdConvidado" class="form-control" placeholder="Seu nome completo">
          </div>
          <div class="mb-3">
            <label class="form-label">Telefone</label>
            <input id="mdTelefone" class="form-control" placeholder="(DDD) 9xxxx-xxxx">
          </div>

          <div class="d-flex gap-2">
            <button id="btnConfirmarPresente" class="btn" style="background:var(--accent-2); color:#111">Confirmar presente</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-..." crossorigin="anonymous"></script>

  <script>
const API_URL = "https://script.google.com/macros/s/AKfycbyb3c2xbNpAjKs1Pf8QxNA9vFQjDH8nJ17752pbB8F5D-y_JSHYnLNyug5Flhlg2ggwVQ/exec";

let presentesCache = [];
const modal = new bootstrap.Modal(document.getElementById("modalDetalhe"));
let presenteSelecionado = null;

Inputmask({ mask: "(99) 99999-9999" }).mask(document.getElementById("telefoneConsulta"));

document.addEventListener("DOMContentLoaded", () => {
  carregarCatalogo();
  feather.replace();
});

document.getElementById("btnRefresh").addEventListener("click", carregarCatalogo);
document.getElementById("btnConsultar").addEventListener("click", () => {
  document.getElementById("telefoneConsulta").focus();
});

document.getElementById("formConsulta").addEventListener("submit", async (e) => {
  e.preventDefault();
  const t = document.getElementById("telefoneConsulta").value.replace(/\D/g, "");
  if (!t) return Swal.fire("Informe o telefone");
  await consultarPorTelefone(t);
});

/* ============================
    GET PRESENTES (JSON)
============================ */
async function carregarCatalogo() {
  showLoading("Carregando cat√°logo...");

  try {
    const resp = await fetch(`${API_URL}?action=getPresentes`, {
      method: "GET"
    });

    const dados = JSON.parse(await resp.text()); // üëà Ajuste: Apps Script entrega como texto
    presentesCache = dados;

    renderCatalogo(presentesCache);
    closeLoading();

  } catch (err) {
    closeLoading();
    Swal.fire("Erro", "N√£o foi poss√≠vel carregar o cat√°logo.", "error");
  }
}

function renderCatalogo(list) {
  const container = document.getElementById("catalogo");
  container.innerHTML = "";

  if (!list.length) {
    container.innerHTML = `<div class="p-4 text-center small-muted">Nenhum presente dispon√≠vel no momento.</div>`;
    return;
  }

  list.forEach((p, idx) => {
    const card = document.createElement("div");
    card.className = "card-presente position-relative card";
    card.style.padding = "0";

    card.innerHTML = `
      <img src="${p.foto || "https://via.placeholder.com/400x240?text=Sem+Imagem"}" class="foto-presente w-100">
      <div class="p-3">
        <h5>${escapeHtml(p.nome)}</h5>
        <div class="small-muted"><a href="${escapeAttr(p.link)}" target="_blank">Clique: <b style="color:blue">Link da loja</b></a></div>
        <div class="mt-3 d-flex">
          <button class="btn btn-sm btn-success ms-auto btn-choose" data-idx="${idx}">Reservar</button>
        </div>
      </div>
    `;

    container.appendChild(card);
  });

  document.querySelectorAll(".btn-open").forEach((b) => b.addEventListener("click", abrirDetalhe));
  document.querySelectorAll(".btn-choose").forEach((b) => b.addEventListener("click", abrirDetalhe));
}

function abrirDetalhe(e) {
  const idx = e.currentTarget.dataset.idx;
  presenteSelecionado = presentesCache[idx];

  document.getElementById("mdFoto").src = presenteSelecionado.foto || "";
  document.getElementById("mdNome").innerText = presenteSelecionado.nome;
  document.getElementById("mdLink").innerHTML = `<a href="${escapeAttr(presenteSelecionado.link)}" target="_blank">Abrir link</a>`;

  document.getElementById("mdConvidado").value = "";
  document.getElementById("mdTelefone").value = "";

  Inputmask({ mask: "(99) 99999-9999" }).mask(document.getElementById("mdTelefone"));

  modal.show();
}

/* ============================
    CONFIRMAR PRESENTE (POST)
============================ */
document.getElementById("btnConfirmarPresente").addEventListener("click", async () => {
  const nome = document.getElementById("mdConvidado").value.trim();
  const telefone = document.getElementById("mdTelefone").value.replace(/\D/g, "");

  if (!nome || !telefone) return Swal.fire("Preencha nome e telefone");

  try {
    showLoading("Confirmando...");

    const resp = await fetch(`${API_URL}?action=registrarEscolha`, {
      method: "POST",
      body: JSON.stringify({
        nomePresente: presenteSelecionado.nome,
        convidado: nome,
        telefone: telefone
      })
    });

    const dados = JSON.parse(await resp.text());
    closeLoading();

    Swal.fire("OK", dados?.mensagem || "Confirmado!", "success");
    modal.hide();
    carregarCatalogo();

  } catch (err) {
    closeLoading();
    Swal.fire("Erro", "N√£o foi poss√≠vel confirmar.", "error");
  }
});

/* ============================
    CANCELAR PRESENTE (POST)
============================ */
document.getElementById("btnCancelarPresente").addEventListener("click", async () => {
  const telefone = document.getElementById("mdTelefone").value.replace(/\D/g, "");
  if (!telefone) return Swal.fire("Informe o telefone");

  const ask = await Swal.fire({ title: "Deseja cancelar?", showCancelButton: true });
  if (!ask.isConfirmed) return;

  try {
    showLoading("Cancelando...");

    const resp = await fetch(`${API_URL}?action=cancelarEscolha`, {
      method: "POST",
      body: JSON.stringify({
        nomePresente: presenteSelecionado.nome,
        telefone
      })
    });

    const dados = JSON.parse(await resp.text());
    closeLoading();

    Swal.fire("OK", dados?.mensagem || "Cancelado", "success");
    modal.hide();
    carregarCatalogo();

  } catch (err) {
    closeLoading();
    Swal.fire("Erro ao cancelar.", "", "error");
  }
});

/* ============================
  CONSULTAR POR TELEFONE (GET)
============================ */
async function consultarPorTelefone(telefone) {
  showLoading("Consultando...");

  try {
    const resp = await fetch(`${API_URL}?action=getEscolhasPorTelefone&telefone=${telefone}`);
    const dados = JSON.parse(await resp.text());
    closeLoading();

    const box = document.getElementById("minhasEscolhas");
    const lista = document.getElementById("listaEscolhas");

    if (!dados.length) {
      box.style.display = "none";
      return Swal.fire("Nenhuma escolha encontrada.");
    }

    // Exibir box
    box.style.display = "block";
    lista.innerHTML = "";

    dados.forEach((item) => {
      const card = document.createElement("div");
      card.className = "card-presente card position-relative";
      card.style.padding = "0";

      card.innerHTML = `
        <img src="${item.foto || 'https://via.placeholder.com/400x240?text=Sem+Imagem'}"
             class="foto-presente w-100">

        <div class="p-3">
          <h5>${escapeHtml(item.nomePresente)}</h5>

          <div class="small-muted">
            Link:
            <a href="${escapeAttr(item.link)}" target="_blank">ver</a>
          </div>

          <button class="btn btn-sm btn-danger mt-3 btn-cancelar"
                  data-nome="${escapeAttr(item.nomePresente)}"
                  data-telefone="${escapeAttr(telefone)}">
            Cancelar escolha
          </button>
        </div>
      `;

      lista.appendChild(card);
    });

    // Eventos dos bot√µes de cancelar
    document.querySelectorAll(".btn-cancelar").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const nomePresente = btn.dataset.nome;
        const tel = btn.dataset.telefone;

        const ask = await Swal.fire({
          title: "Deseja cancelar este presente?",
          showCancelButton: true
        });

        if (!ask.isConfirmed) return;

        try {
          showLoading("Cancelando...");
          const resp = await fetch(`${API_URL}?action=cancelarEscolha`, {
            method: "POST",
            body: JSON.stringify({
              nomePresente: nomePresente,
              telefone: tel
            })
          });

          const dados = JSON.parse(await resp.text());
          closeLoading();

          Swal.fire("OK", dados?.mensagem || "Cancelado", "success");
          carregarCatalogo();
          consultarPorTelefone(tel); // Recarregar lista

        } catch (err) {
          closeLoading();
          Swal.fire("Erro ao cancelar.", "", "error");
        }
      });
    });

  } catch (err) {
    closeLoading();
    Swal.fire("Erro ao consultar.");
  }
}


/* ============================
      Helpers
============================ */
function showLoading(text = "Carregando...") {
  Swal.fire({ title: text, allowOutsideClick: false, didOpen: () => Swal.showLoading() });
}

function closeLoading() {
  Swal.close();
}

function escapeHtml(s) {
  return s?.replace(/[&<>"]/g, (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c]));
}

function escapeAttr(s) {
  return s?.replace(/"/g, "&quot;");
}
</script>



</body>
</html>

